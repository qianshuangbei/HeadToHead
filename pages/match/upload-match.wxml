<!--pages/match/upload-match.wxml-->
<view class="container">
  <!-- 顶部渐变装饰区域 -->
  <view class="header-gradient">
    <view class="form-title">上传比赛</view>
  </view>

  <view class="form-container">
    <!-- 比赛类型选择 -->
    <view class="form-group">
      <picker
        bindchange="onMatchTypeChange"
        value="{{selectedMatchTypeIndex}}"
        range="{{matchTypeOptions}}"
        range-key="label"
      >
        <view class="picker">
          {{matchTypeOptions[selectedMatchTypeIndex].label}}
        </view>
      </picker>
    </view>

    <!-- 单打模式 -->
    <view wx:if="{{selectedMatchType === 'singles'}}" class="singles-section">
      <!-- 单打比分输入 - 头像 vs 头像 -->
      <view class="singles-match-layout">
        <!-- 玩家A（当前用户） -->
        <view class="player-section">
          <view class="avatar-container">
            <image
              class="avatar"
              src="{{currentUser && currentUser.display_avatar ? currentUser.display_avatar : '/images/default-avatar.png'}}"
              mode="aspectFill"
            />
          </view>
          <input
            class="score-box"
            type="number"
            placeholder="0"
            value="{{score_a}}"
            bindinput="onScoreAInput"
          />
        </view>

        <!-- VS 文字 -->
        <view class="vs-text">VS</view>

        <!-- 玩家B（对手） -->
        <view class="player-section">
          <input
            class="score-box"
            type="number"
            placeholder="0"
            value="{{score_b}}"
            bindinput="onScoreBInput"
          />
          <view class="avatar-container">
            <image
              class="avatar"
              src="{{selectedOpponent && selectedOpponent.avatar ? selectedOpponent.avatar : '/images/default-avatar.png'}}"
              mode="aspectFill"
            />
          </view>
        </view>
      </view>
    </view>

    <!-- 双打模式 -->
    <view wx:if="{{selectedMatchType === 'doubles'}}" class="doubles-section">
      <!-- 双打比分输入 - 2个头像 vs 2个头像 -->
      <view class="doubles-match-layout">
        <!-- 队伍A（包含当前用户） -->
        <view class="team-section">
          <view class="avatars-group">
            <!-- 玩家A1（当前用户） -->
            <view class="avatar-container">
              <image
                class="avatar"
                src="{{currentUser && currentUser.avatar ? currentUser.avatar : '/images/default-avatar.png'}}"
                mode="aspectFill"
              />
            </view>
            <!-- 玩家B（队友） - 可点击选择 -->
            <picker
              bindchange="onPlayerBChange"
              value="{{playerBIndex}}"
              range="{{opponents}}"
              range-key="nickname"
            >
              <view class="avatar-container clickable">
                <image
                  class="avatar"
                  src="{{playerB && playerB.avatar ? playerB.avatar : '/images/default-avatar.png'}}"
                  mode="aspectFill"
                />
                <view wx:if="{{!playerB}}" class="avatar-placeholder">
                  <text class="plus-icon">+</text>
                </view>
              </view>
            </picker>
          </view>
          <input
            class="score-box"
            type="number"
            placeholder="0"
            value="{{score_a}}"
            bindinput="onScoreAInput"
          />
        </view>

        <!-- VS 文字 -->
        <view class="vs-text">VS</view>

        <!-- 队伍B（对手队伍） -->
        <view class="team-section">
          <input
            class="score-box"
            type="number"
            placeholder="0"
            value="{{score_b}}"
            bindinput="onScoreBInput"
          />
          <view class="avatars-group">
            <!-- 玩家C - 可点击选择 -->
            <picker
              bindchange="onPlayerCChange"
              value="{{playerCIndex}}"
              range="{{opponents}}"
              range-key="nickname"
            >
              <view class="avatar-container clickable">
                <image
                  class="avatar"
                  src="{{playerC && playerC.avatar ? playerC.avatar : '/images/default-avatar.png'}}"
                  mode="aspectFill"
                />
                <view wx:if="{{!playerC}}" class="avatar-placeholder">
                  <text class="plus-icon">+</text>
                </view>
              </view>
            </picker>
            <!-- 玩家D - 可点击选择 -->
            <picker
              bindchange="onPlayerDChange"
              value="{{playerDIndex}}"
              range="{{opponents}}"
              range-key="nickname"
            >
              <view class="avatar-container clickable">
                <image
                  class="avatar"
                  src="{{playerD && playerD.avatar ? playerD.avatar : '/images/default-avatar.png'}}"
                  mode="aspectFill"
                />
                <view wx:if="{{!playerD}}" class="avatar-placeholder">
                  <text class="plus-icon">+</text>
                </view>
              </view>
            </picker>
          </view>
        </view>
      </view>
    </view>

    <!-- 比赛日期 -->
    <view class="form-group">
      <picker mode="date" value="{{matchDate}}" bindchange="onDateChange">
        <view class="picker">
          {{matchDate || '选择日期'}}
        </view>
      </picker>
    </view>

    <!-- 标签 (可选) -->
    <view class="form-group">
      <label class="form-label">标签 (可选)</label>
      <view class="tags">
        <text
          class="tag {{tags.includes('ACE') ? 'active' : ''}}"
          bindtap="toggleTag"
          data-tag="ACE"
        >
          ACE
        </text>
        <text
          class="tag {{tags.includes('破发') ? 'active' : ''}}"
          bindtap="toggleTag"
          data-tag="破发"
        >
          破发
        </text>
        <text
          class="tag {{tags.includes('反转') ? 'active' : ''}}"
          bindtap="toggleTag"
          data-tag="反转"
        >
          反转
        </text>
      </view>
    </view>

    <!-- 信息提示 -->
    <view class="info-box">
      <text>💡 上传后对手需确认才能进入排名。请确保比分信息准确。</text>
    </view>

    <!-- 操作按钮 -->
    <view class="button-group">
      <button class="btn btn-primary" bindtap="handleUpload" disabled="{{loading}}">
        {{loading ? '上传中...' : '上传比赛'}}
      </button>
      <button class="btn btn-secondary" bindtap="handleCancel">取消</button>
    </view>
  </view>
</view>
